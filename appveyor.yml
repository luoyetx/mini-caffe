version: 1.0.{build}

pull_requests:
  do_not_increment_build_number: true

skip_tags: true
skip_branch_with_pr: true

image: Visual Studio 2013

environment:
  URL_3rdparty: https://github.com/luoyetx/misc/blob/master/mini-caffe/3rdparty.zip?raw=true
  URL_model: https://github.com/luoyetx/misc/blob/master/mini-caffe/model.zip?raw=true

install:
  - ps: |
      if (!(Test-Path "3rdparty.zip")) {
        echo "Downloading 3rdparty.zip from ${env:URL_3rdparty}"
        appveyor DownloadFile "${env:URL_3rdparty}" -FileName 3rdparty.zip -Timeout 1200000
      }
      if (!(Test-Path "cuda_8.0.44_windows.exe")) {
        echo Downloading CUDA toolkit 8 ...
        appveyor DownloadFile  https://developer.nvidia.com/compute/cuda/8.0/prod/local_installers/cuda_8.0.44_windows-exe -FileName cuda_8.0.44_windows.exe
      }
  - cmd: |
      7z x 3rdparty.zip -y -o"%APPVEYOR_BUILD_FOLDER%" >NUL
  - cmd: |
      echo Installing CUDA toolkit 8 ...
      cuda_8.0.44_windows.exe -s compiler_8.0 cublas_8.0 cublas_dev_8.0 cudart_8.0
      :: Add CUDA toolkit to PATH
      set PATH=%ProgramFiles%\NVIDIA GPU Computing Toolkit\CUDA\v8.0\bin;%ProgramFiles%\NVIDIA GPU Computing Toolkit\CUDA\v8.0\libnvvp;%PATH%
      nvcc -V

before_build:
  - cmd: |
      call generatepb.bat

build_script:
  - cmd: |
      mkdir build
      cd build
      :: CUDA build
      cmake .. -DUSE_CUDA=ON -G "Visual Studio 12 2013 Win64"
      msbuild mini-caffe.sln /t:Rebuild /p:Configuration=Release;Platform=x64 /m
      cmake .. -DUSE_CUDA=OFF -G "Visual Studio 12 2013 Win64"
      msbuild mini-caffe.sln /t:Rebuild /p:Configuration=Release;Platform=x64 /m
      cd ..

before_test:
  - ps: |
      if (!(Test-Path "model.zip")) {
        echo "Downloading model.zip from ${env:URL_model}"
        appveyor DownloadFile "${env:URL_model}" -FileName model.zip -Timeout 1200000
      }
  - cmd: |
      7z x model.zip -y -o"%APPVEYOR_BUILD_FOLDER%/build/Release" >NUL
      copy 3rdparty\bin\*.dll build\Release

test_script:
  - cmd: |
      cd build\Release
      run_net

branches:
  only:
    - master

cache:
  - 3rdparty.zip -> appveyor.yml
  - model.zip -> appveyor.yml
  - cuda_8.0.44_windows.exe -> appveyor.yml
